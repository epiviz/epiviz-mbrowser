<!-- Polymer dependency -->
<link rel="import" href="../polymer/polymer-element.html" />

<!-- External Polymer Styles/elements dependency -->
<link rel="import" href="../paper-dialog/paper-dialog.html" />
<link rel="import" href="../paper-dialog-scrollable/paper-dialog-scrollable.html" />
<!-- <link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html"> -->
<link rel="import" href="../paper-menu-button/paper-menu-button.html" />
<link rel="import" href="../paper-icon-button/paper-icon-button.html" />
<link rel="import" href="../paper-listbox/paper-listbox.html" />
<link rel="import" href="../paper-button/paper-button.html" />
<link rel="import" href="../paper-item/paper-item.html" />
<link rel="import" href="../paper-styles/paper-styles.html" />
<link rel="import" href="../iron-icons/editor-icons.html" />
<link rel="import" href="../data-filter/data-filter.html" />
<link rel="import" href="../paper-tabs/paper-tabs.html" />
<link rel="import" href="../iron-pages/iron-pages.html" />
<link rel="import" href="../paper-dropdown/paper-dropdown.html" />
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html" />
<link rel="import" href="../paper-spinner/paper-spinner-lite.html" />

<script>
  // window.addEventListener('WebComponentsReady', function() {
      document.addEventListener('mBrowserReady', function() {
          var project = getUrlParameter("project");

          if(project) {
            // document.querySelector("epiviz-measurement-browser").openProject(project);
            document.querySelector("epiviz-app").shadowRoot.querySelector("epiviz-navigation")
                   .shadowRoot.querySelector("epiviz-measurement-browser").openProject(project);
          } else {
            var collection = getUrlParameter("collection");

            if(collection) {
              // document.querySelector("epiviz-measurement-browser").openCollection(collection);
                document.querySelector("epiviz-app").shadowRoot.querySelector("epiviz-navigation")
                   .shadowRoot.querySelector("epiviz-measurement-browser").openCollection(collection);
            }
          }
      });
  // });

  function getUrlParameter(sParam) {
      var currPage = decodeURIComponent(window.location.search.substring(1));
      var pageVars = currPage.split('&');

      for (var i = 0; i < pageVars.length; i++) {
          var pageParamName = pageVars[i].split('=');

          if (pageParamName[0] === sParam) {
              return pageParamName[1] === undefined ? true : pageParamName[1];
          }
      }
  };
</script>

<!--
`<epiviz-measurement-browser>`
    Creates an Instance of the measurement browser.
-->
<dom-module id="epiviz-measurement-browser">
  <template>
    <style>
      paper-button {
        --paper-button: {
          display: inline;
          background: #4285f4;
          color: #fff;
          padding: 5px;
        }
      }

      paper-dropdown {
        margin: 0px 15px 0px 15px;
      }

      paper-dialog :host{
        overflow: hidden;
      }

      .scrollable{
        overflow-x: hidden;
        overflow-y: auto;
      }

      :host .spinner-overlay {
        position: absolute;
        width: 75px;
        height: 75px;
        z-index: 10;
        top: 50%;
        left: 50%;
        transform: translateX(-50%) translateY(-50%);
        background-color: #00000040;

        display: flex;
        justify-content: center;
        align-items: center;
      }

      .header {
        display: flex;
        justify-content: space-around;
        align-items: center;
      }

      #modal {
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: fixed;
        top: 0;
        left: 0;
        max-height: calc(100vh - 48px);
        width: 90%;
      }

      iron-image {
        padding: 1em;
      }

      iron-pages {
        max-height: inherit;
      }

      data-filter {
        height: auto;
      }

      paper-tabs {
        --paper-tab-ink: var(--paper-blue-grey-200);
        --paper-tabs-selection-bar-color: var(--paper-blue-500);
        background-color: var(--google-grey-300);
      }

      .dialog-content {
        max-height: inherit;
      }

      .buttonContainer {
        display: inline-block;
        padding: 8px;
      }

      .infoMessage {
        text-align: center;
        @apply --paper-font-subhead;
      }

      .title {
        display: inline;
        @apply --paper-font-title;
        position: relative;
        top: 8px;
      }

      /* paper-listbox {
        height: min(auto, 500px);
      } */

      paper-listbox > paper-item:not(:last-child) {
        border-bottom: 1px solid gray;
        width: 250px;
      }
    </style>
    <!-- local DOM goes here -->
    <iron-ajax id="getProjects" method="GET" 
      loading={{loading}}
      url="[[msApi]]projects/"
      on-error="_errorHandler"
      handle-as="json" on-response="handleGetProjects" debounce-duration="300">
    </iron-ajax>

    <iron-ajax id="getCollections" method="GET"
      loading={{loading}}
      on-error="_errorHandler"
      url="[[msApi]]projects/[[projectId]]/collections" handle-as="json"
      on-response="handleGetCollections" debounce-duration="300"></iron-ajax>
    </iron-ajax>

    <iron-ajax id="getMeasurements" method="POST"
      loading={{loading}}
      on-error="_errorHandler"
      handle-as="json"
      on-response="handleGetMeasurements" debounce-duration="300">
    </iron-ajax>

    <iron-ajax id="getStats" method="GET"
    loading={{loading}}
    on-error="_errorHandler"
    handle-as="json"
    url="[[msApi]]/collections/[[collectionId]]/stats" handle-as="json"
    on-response="handleGetStats" debounce-duration="300">
  </iron-ajax>

    <template is="dom-if" if="{{!_isEnvironment(_charts)}}">
      <div class="buttonContainer">
        <paper-button raised on-tap="_showModal">
          <iron-icon icon="editor:insert-chart"></iron-icon>
          <span>Add Chart</span>
        </paper-button>
      </div>
    </template>

    <template is="dom-if" if="{{_isEnvironment(_charts)}}">
      <paper-menu-button dynamic-align horizontal-align="right" vertical-offset="42">
        <paper-button slot="dropdown-trigger" raised>
          <iron-icon icon="editor:insert-chart"></iron-icon>
          <span>Add Chart</span>
        </paper-button>
        <paper-listbox slot="dropdown-content">
          <paper-item on-tap="_showModal">Add Genomic Range</paper-item>
          <paper-item on-tap="_addNavigation">Add Navigation</paper-item>
        </paper-listbox>
      </paper-menu-button>
    </template>

    <paper-dialog id="modal" modal>
      <template is="dom-if" if="[[error]]">
        <p class="infoMessage">
          Please close this popup and login from the top right corner of this app.
          <br/>
          If you continue to see this error, please  
          <a href="https://sites.google.com/gene.com/genomicsplatform/gepiviz/telling-gepiviz-about-your-data"
            target="_blank">
            check the documentation</a> 
          on how to add this dataset to your list.

          
          <br/>
          Click here to show currently available datasets
          <br/>
          <paper-button on-tap="_loadDefaulProjects">show available datasets</paper-button>        </p>
        <div class="buttons">
          <paper-button on-tap="_close" dialog-dismiss>Close</paper-button>
        </div>
      </template>
      <template is="dom-if" if="[[!error]]">
      
        <div class="header">
            <div>
              <paper-dropdown-menu always-float-label horizontal-align="left" vertical-offset="42" id="collectionProject" label="Choose Project" no-animations>
                <paper-listbox slot="dropdown-content" class="dropdown-content" selected="{{projectId}}" attr-for-selected="value">
                  <template is="dom-repeat" items="[[_getProjectKeys(projects)]]">
                    <paper-item value$="[[item]]">[[_getProjectValue(item)]]</paper-item>
                  </template>
                </paper-listbox>
              </paper-dropdown-menu>
            </div>
            <div>
              <paper-dropdown-menu always-float-label horizontal-align="left" vertical-offset="42" id="collectionElement" label="Choose Collection" no-animations>
                <paper-listbox slot="dropdown-content" class="dropdown-content" selected="{{collectionId}}" attr-for-selected="value">
                  <template id="collRepeater" is="dom-repeat" items="[[_getCollectionKeys(collectionsObj)]]">
                    <paper-item value$="[[item]]">[[_getCollectionValue(item)]]</paper-item>
                  </template>
                </paper-listbox>
              </paper-dropdown-menu>
            </div>
            <div>
              <paper-dropdown-menu disabled=[[isChartSelectionDisabled]] always-float-label horizontal-align="left" vertical-offset="42" label="Choose chart type" no-animations>
                <paper-listbox slot="dropdown-content" class="dropdown-content" selected="{{selectedChart}}" attr-for-selected="value">
                  <template is="dom-repeat" items="[[_charts]]" mutable-data>
                    <paper-item on-click="_updateMeasurementView" value$="[[item]]">[[item]]</paper-item>
                  </template>
                </paper-listbox>
              </paper-dropdown-menu>
              <paper-tabs style="display: none" selected="{{tabSelected}}" noink>
                <paper-tab>All datasets </paper-tab>
              </paper-tabs>
            </div>
        </div>
          <div class="scrollable">
              <div class="dialog-content">
                <template is="dom-if" if="[[!error)]]">
                  <data-filter pagination={{pagination}} measurements-search={{measurementsSearch}} filters="[[stats]]" filters-ext="{{filtersExt}}" id="cardElem" data="[[_jsonMeasurements]]" class="new-charts"
                    selected-items="{{selectedMeasurements}}">
                  </data-filter>
                </template>
              </div>
            </div>  
          </div>
        </div>  
      </div>
        </div>  
        <div class="buttons">
          <paper-button on-tap="_close" dialog-dismiss>Close</paper-button>
          <paper-button on-tap="_submit"
            disabled="{{!_enableButton(selectedChart, selectedMeasurements.*, selectedExistingMeasurements.*, tabSelected.*)}}"
            dialog-confirm autofocus>Add Chart
          </paper-button>
        </div>
      </template>
      <template is="dom-if" if="[[loading]]">
        <paper-spinner-lite class="spinner-overlay" active=[[loading]]></paper-spinner-lite>
      </template>
    </paper-dialog>
  </template>

  <script>

    // Extend Polymer.Element base class
    class EpivizMeasurementBrowser extends Polymer.Element {

      static get is() { return 'epiviz-measurement-browser'; }

      static get properties() {
        return {

          msApi: {
            type: String
          },

          measurementsRaw: {
            type: Array,
            notify: true,
            value: []
          },

          searchMeasurementsRaw: {
            type: Array,
            notify: true,
            value: []
          },

          genome: {
            type: String,
            notify: true,
            value: "hg38"
          },

          error: {
            type: Boolean,
            value: false
          },

          /**
          * currently available measurements on the app
          * uses measurements available from the `epiviz-data-source` element.
          *
          * @type {Array.<epiviz.ui.charts.CustomSetting>}
          */
          measurements: {
            type: Object,
            notify: true
          },

          /**
          * selected measurements from browser.
          * chartType:
          * measurement:
          * @type {Object}
          */
          selection: {
            type: Object,
            notify: true,
            value: {}
          },

          selectedMeasurements: {
            type: Array,
            notify: true,
            observer: "_selectedMeasurementsObserver"
          },

          selectedExistingMeasurements: {
            type: Array,
            notify: true,
          },

          /**
          * selected chart from the browser.
          *
          * @type {Array.<epiviz.ui.charts.CustomSetting>}
          */
          selectedChart: {
            type: String,
            notify: true,
            observer: "_refitModal",
          },
          
          isChartSelectionDisabled: {
            type: Boolean,
            value: false,
          },

          /**
          * currently available chart types on the app.
          */
          _chartTypes: {
            type: Object,
            notify: true,
            reflectToAttribute: true,
            value: function () {
              return {
                // "GenesTrack": "epiviz-genes-track",
                "TranscriptTrack": "epiviz-transcript-track",
                "BlocksTrack": 'epiviz-blocks-track',
                "InteractionTrack": 'epiviz-interaction-track',
                "StackedBlocksTrack": 'epiviz-stacked-blocks-track',
                "HeatmapPlot": "epiviz-heatmap-plot",
                "ScatterPlot": "epiviz-scatter-plot",
                "LineTrack": 'epiviz-line-track',
                "GwasTrack": 'epiviz-gwas-track',
                "StackedLineTrack": 'epiviz-stacked-line-track',
                "MultiStackedLineTrack": 'epiviz-multistacked-line-track',
                "MirrorLineTrack": "epiviz-line-track-mirror",
                "LinePlot": 'epiviz-line-plot',
                "StackedLinePlot": 'epiviz-stacked-line-plot',
                "EpivizNavigation": 'epiviz-navigation'
              }
            }
          },

          relevantCharts: {
            type: Array,
            notify: true
          },

          _charts: {
            type: Array,
            notify: true,
            value: [],
          },

          /**
          * parentContainer
          */
          _parentContainer: {
            type: Object,
          },

          _jsonMeasurements: {
            type: Array,
            value: [],
          },

          tabSelected: {
            type: Number,
            notify: true,
            value: function () {
              return 0;
            },
            observer: "_refitModal",
          },

          projects: {
            type: Array,
            notify: true
          },

          projectId: {
            type: String,
            notify: true,
            observer: "_projectIdChanged"
          },

          collectionId: {
            type: String,
            notify: true,
            observer: "_collectionIdChanged"
          },
          
          collections: {
            type: Array,
            notify: true
          },
          
          collectionsObj: {
            type: Object,
            // notify: true
          },

          filters: {
            type: Array,
            notify: true
          },

          pagination: {
            type: Object,
            observer: "_paginationChanged"
          },

          measurementsSearch: {
            type: String,
            observer: "_measurementsSearchChanged"
          },

          initialLaunch: {
            type: Number,
            value: 1
          },

          collectionGenome: {
            type: String,
            notify: true,
            reflectToAttribute: true,
            observer: "_collectionGenomeChanged"
          },

          user: {
            type: String,
            notify: true
          },

          userToken: {
            type: String,
            notify: true
          },

          filtersExt: {
            type: Array,
            observer: "_filterExtChanged"
          },
        }
      }

      constructor() {
        super();
      }

      static get observers() {
        return [
          '_userChanged(user, userToken)'
        ];
      }

      connectedCallback() {
        super.connectedCallback();

        document.dispatchEvent(new CustomEvent('mBrowserReady',
          {
            bubbles: true
          }
        ));
      }

      _getSanitizeItemName(name) {
          return name.replace("annotation.", "")
      }

      _getFilters(filters){
        const emptyFilter = {filter_by:[]};
        if (!this.stats) {
          return emptyFilter;
        }
        
        if (filters != undefined) {
          const filtersList = [];
          Object.keys(filters).forEach(it => {
            if (this.filtersExt[it].length == 0) {
              return;//continue
            }
            const filter = this.stats.find(filter => filter.name === it)

            filtersList.push({
              name: this._getSanitizeItemName(it),
              type: filter.type,
              values: this.filtersExt[it].reduce((acc, filter) => {
                acc[filter] = null;
                return acc;
              }, {}),
            });
          })
          return {filter_by: filtersList};
        }
        return emptyFilter;
      }

      disconnectedCallback() {
        super.disconnectedCallback();
      }

      ready() {
        super.ready();
      }

      _errorHandler(error) {
        this.set('error', true)
      }

      _showTable(error, ms) {
        if (this.error){
          return false;
        }

        return this._tableDataExists(ms);
      }
 
      _selectedMeasurementsObserver(newVal, oldVal) {
        this.set('isChartSelectionDisabled', (newVal && newVal.length > 0));
      }

      _generateMesurementsRequestUrl() {
        const { msApi, measurementsSearch, genome, collectionId, offset } = this;
        this.$.getMeasurements.body= JSON.stringify(this._getFilters(this.filtersExt));
        debugger;
        let req =`${msApi}collections/${collectionId}/ms?genome=${genome}`;
        if (measurementsSearch !== undefined) {
          req +=`&query=${measurementsSearch}`;
        }
        if (this.pagination && this.pagination.offset !== undefined) {
          req += `&limit=${this.pagination.offset}`;
        }
        if (offset !== undefined) {
          req +=`&offset=${offset}`;
        }
        if (this.isChartSelectionDisabled) {
          req +=`&chart=${this.selectedChart}`;
        }
        return req;
      }

      _fetchMeasurements() {
        this.$.getMeasurements.body= JSON.stringify(this._getFilters({}));
        this.$.getMeasurements.url = this._generateMesurementsRequestUrl();
        this.$.getMeasurements.generateRequest();
      }

      _collectionIdChanged(newVal, oldVal) {
        if (newVal) {
          this.offset = 0;
          this._fetchMeasurements();
          this.$.getStats.generateRequest();
        }
      }

      _measurementsSearchChanged(newVal, oldVal) {
        const measurementReq = this.$.getMeasurements;
        this.offset = 0;
        measurementReq.url = this._generateMesurementsRequestUrl();
        measurementReq.generateRequest();
      }

      _paginationChanged(newVal, oldVal) {
        if (newVal.page !== (oldVal && oldVal.page)) {
          debugger;
          this.offset = newVal.page * newVal.limit;
          this.$.getMeasurements.url = this._generateMesurementsRequestUrl();
          this.$.getMeasurements.generateRequest();
        }
      }

      _emptyObj(obj) {
        if (!obj) {
          return true;
        }
        return Object.keys(obj).length === 0 && obj.constructor === Object;
      }

      _filterExtChanged(newVal, oldVal) {
        if (this._emptyObj(newVal), this._emptyObj(oldVal)){
          return ;
        }
        if (this.collectionId) {
          debugger;
          this.offset = 0;
          this.$.getMeasurements.url = this._generateMesurementsRequestUrl();
          this.$.getMeasurements.generateRequest();
        }
      }

      _filterChanged(newVal, oldVal) {
        if (newVal && Object.keys(newVal).length === 0 && newVal.constructor === Object //check newVal = {}
        && oldVal === undefined) {
          return;
        }
      }

      _projectIdChanged(newVal, oldVal) {
        if (newVal) {
          this.offset = 0;
          this.$.getCollections.generateRequest();
        }
      }

      _projectIdSelected(e) {
        for (var d in this.projects) {
          if (this.projects[d].name == e.target.value) {
            this.projectId = this.projects[d].project_id;
            break;
          }
        }
      }

      _collectionIdSelected(e) {
        for (var d in this.collectionsObj) {
          if (this.collectionsObj[d].name == e.target.value) {
            this.collectionId = this.collectionsObj[d].collection_id;
            break
          }
        }
      }

      _collectionGenomeChanged(nVal, oVal) {
        var self = this;

        if (!nVal) {
          return;
        }

        if (self.projects) {
          let projects = {}
          Object.keys(self.projects).forEach(function(prj) {
            if(!self.projects[prj].genomes.includes(self.genome)) {
              return ;//skip;
            }
            projects[prj] = self.projects[prj];
          });

          self.setProperties({
            projects: projects,
          });
        }

        if (self.collectionsObj) {
          let colls = {}
          Object.keys(self.collectionsObj).forEach(function(coll) {
            if(!self.collectionsObj[coll].genomes.includes(self.genome)) {
              return ;//skip;
            }
            colls[coll] = self.collectionsObj[coll];
          });

          self.setProperties({
            collectionsObj: colls,
          });
        }

        self._refitModal();
      }

      handleGetProjects(e) {
        var self = this;
        const data = e.detail.response;

        const projects = {};
        data.forEach((it) => {
          if(!it.genomes.includes(this.genome)  && !self.autoOpen) {
            return ;//skip;
          }
          projects[it.project_id] = it;
        });

        this.setProperties({
          projects: projects,
        });

        if (!this.projectId) {
          this.set("projectId", Object.keys(projects)[0]);
        }

        if (!projects[this.projectId]) {
          this.set("error", true);
        } else {
          this.set("error", false);
        }
        // this._refitModal();
      }

      handleGetCollections(e) {
        var self = this;
        const data = e.detail.response;

        const collections = data;
        const collectionsObj = {};

        data.forEach((it) => {
          if(!it.genomes.includes(this.genome)  && !self.autoOpen) {
            return ;
          }
          collectionsObj[it.collection_id] = it;
        });

        self.setProperties({
          collectionsObj: collectionsObj,
          // filtersExt: {},
        });

        if(self.initialLaunch == 1 && self.autoOpen) {
          let tgenome = collectionsObj[Object.keys(collectionsObj)[0]].genomes;
          if (self.collectionId) {
            tgenome = collectionsObj[self.collectionId].genomes;
          }

          if (!tgenome.includes(self.genome)) {
            self.genome = tgenome[0];

            self.set("collectionGenome", self.genome);
          }
        }

        if (self.projects) {
          let projects = {}
          Object.keys(self.projects).forEach(function(prj) {
            if(!self.projects[prj].genomes.includes(self.genome)) {
              return ;//skip;
            }
            projects[prj] = self.projects[prj];
          });

          self.setProperties({
            projects: projects,
          });

          self._refitModal();
        }

        if (self.collectionsObj) {
          let colls = {}
          Object.keys(self.collectionsObj).forEach(function(coll) {
            if(!self.collectionsObj[coll].genomes.includes(self.genome)) {
              return ;//skip;
            }
            colls[coll] = self.collectionsObj[coll];
          });

          self.setProperties({
            collectionsObj: colls,
          });
        }

        if (self.initialLaunch > 1 || !self.collectionId) {
          self.collectionId = undefined;
          setTimeout(() => { self.collectionId = Object.keys(self.collectionsObj)[0]; }, 0);
        }
      }

      handleGetStats(e){
        const data = e.detail.response;
        const stats = data.stats.map(it => {
          it.values = Object.keys(it.values);
          return it;
        })
        this.setProperties({
          stats,
        });

        if (!this.isChartSelectionDisabled) {
          this.set('_charts', data.charts);
          this.set('selectedChart', data.charts[0]);
        }
      }

      handleGetMeasurements(e) {
        debugger;
        const data = e.detail.response;
        this.measurementsHandling(data);
        this.initialLaunch++;
      }

      _precookMeasurements(measurements) {
        const pdata = []
        measurements.forEach(function (m) {
          var ptype = "feature";
          if (["annotation"].includes(m.datatype)) {
            ptype = "range";
          }

          var tmea = {
            "id": m.measurement_id,
            "name": m.name,
            "type": ptype,
            "datasourceId": m.url,
            "datasourceGroup": m.url,
            "dataprovider": "fileapi",
            "formula": null,
            "defaultChartType": "track",
            "annotation": m.annotation,
            "metadata": m.metadata,
            "minValue": 0,
            "maxValue": 5
          }

          tmea.annotation.collection = m.collection_id;
          tmea.annotation.collection_name = m.collection_name;
          tmea.annotation._filetype = m.file_type;
          tmea.annotation.genome = m.genome;

          pdata.push(tmea);
        });
        return pdata;
      }

      measurementsHandling(data) {
        const {summary, records} = data;
        const envElement = this._parentContainer;
        const {total_records, limit} = summary;
        this.set('pagination', {total_records, limit, page: (this.offset || 0)/limit});
        this.measurementsRaw = this._precookMeasurements(records);
        this.searchMeasurementsRaw = this.searchMeasurementsRaw.concat(this.measurementsRaw);
        const tcurrChart = this._getExistingChartMeasurements(envElement);
        this.currentChartObj = tcurrChart.currentChartObj;
        this.currChartCollections = tcurrChart.currChartCollections;

        this._updateMeasurementView();

        this.$.modal.refit();
      }

      _getJSONMeasurements(data) {
        return data.raw();
      }

      _getProjectKeys(projects) {
        return Object.keys(projects);
      }

      _getProjectValue(item) {
        return this.projects[item].project_id ? this.projects[item].name : item;
      }

      _getCollectionKeys(collectionsObj) {
        return Object.keys(collectionsObj);
      }

      _getCollectionValue(item) {
        return this.collectionsObj[item] ? this.collectionsObj[item].name : item;
      }

      _updateMeasurementView() {
        let data = [];
        this.selection = {};
        
        this.selection.chartType = this.selectedChart;
        this.measurements = this.measurementsRaw;

        const nData = this._clearMeasurementsData(this.measurements, this.genome);

        this.set("_jsonMeasurements", nData);
        this.$.modal.refit();
      }

      _clearMeasurementsData(measurements, genome) {
        const clearedMeasurements = [];
        const mData = JSON.parse(JSON.stringify(measurements));
        mData.forEach(function (d, i) {

          if (d.annotation["genome"] == genome) {
            let temp = d.annotation;
            if (temp == undefined) {
              temp = {};
            }

            delete temp["tags"];
            delete d["datasourceId"];
            delete d["datasourceGroup"];
            delete d["dataprovider"];
            delete d["formula"];
            delete d["defaultChartType"];
            delete d["metadata"];
            delete d["minValue"];
            delete d["maxValue"];

            d.annotation = temp;
            clearedMeasurements.push(d);
          }
        });

        return clearedMeasurements;
      }

      _isEnvironment(chartTypes) {
        return false;
      }

      _tableDataExists(tableData) {
        return tableData && tableData.length > 0;
      }

      _enableButton(selectedChart, selectedMeasurements, selectedExistingMeasurements, tabSelected) {
        if (selectedChart !== null && this._charts.includes(selectedChart)) {
          if (this.tabSelected === 1 && this.selectedExistingMeasurements && this.selectedExistingMeasurements.length > 0) {
            return true;
          }

          if (this.tabSelected === 0 && selectedMeasurements.value && selectedMeasurements.value.length > 0) {
            return true;
          }
        }
        return false;
      }

      /**
       * API to add a chart
       * @param {chartType}: chart type to add/create. Must be one of the defined chart types in _chartTypes attribute.
       * @param {measurements}: measurements to use.
       * TODO:
       * @param {data}: data for the chart (for json-based-charts).
       */
      _addChart(chartType, measurements) {

        var self = this;
        var envElement = self.parentNode.parentNode.parentNode.parentNode.nodeName == "EPIVIZ-NAVIGATION" ? self.parentNode.parentNode.parentNode.parentNode : self.parentNode.parentNode.parentNode;
        var envElement = self._parentContainer;

        var chartElem = document.createElement(self._chartTypes[chartType]);
        chartElem.slot = "charts";
        chartElem.range = envElement.range;
        var chartElemType = chartElem._createChart();

        chartElem.setAttribute("measurements", JSON.stringify(measurements));
        envElement.appendChild(chartElem);
      }

      _refitModal() {
        setTimeout(() => this.$.modal.refit(), 0);
      }

      _addNavigation() {
        var envElement = this._parentContainer;
        var elem = document.createElement("epiviz-navigation");

        elem.setAttribute("chr", "chr19");
        elem.setAttribute("start", 10084603);
        elem.setAttribute("end", 10312571);
        elem.setAttribute("no-logo", true);
        elem.slot = "charts";

        envElement.appendChild(elem);
      }

      _getExistingChartMeasurements(envElement) {
        const currentCharts = [];
        const currentChartObj = {};
        const currChartCollections = [];

        if (envElement) {
          let navChildren =
            Polymer.FlattenedNodesObserver.getFlattenedNodes(envElement).filter(n => n.nodeType === Node.ELEMENT_NODE);
          const numChildren = navChildren.length;
          for (let index = 0; index < numChildren; index++) {
            const currentChild = navChildren[index];
            currentCharts.push({ "node": currentChild.nodeName, "id": currentChild.plotId });
            currentChartObj[currentChild.plotId] = currentChild.measurements;
            if (currentChild.nodeName != "EPIVIZ-GENES-TRACK") {
              currentChild.measurements.forEach(function (m) {
                const tempM = JSON.parse(JSON.stringify(m));
                if (!tempM["annotation"]) {
                  tempM["annotation"] = {};
                }
                tempM["annotation"]["collection"] = currentChild.plotId;
                currChartCollections.push(tempM);
              });
            }
          }
        }

        return {
          "currentChartObj": currentChartObj,
          "currentCharts": currentCharts,
          "currChartCollections": currChartCollections
        }
      }

      _loadDefaulProjects(e) {
        this.setProperties({
          projectId: Object.keys(this.projects)[0],
          error: false
        });
        setTimeout(() => this.$.modal.refit(), 0);
      }

      _showModal(event) {
        this.autoOpen = false;

        this.projectId = null;
        this.collectionId = null;
        
        var ajaxElem = this.$.getProjects;
        if (this.userToken && this.userToken != "undefined") {
          ajaxElem.headers = {"Authorization": "Bearer " + this.userToken};
        }
        ajaxElem.generateRequest();

        this.$.modal.open();
        this.$.modal.refit();

        if(this.shadowRoot.querySelector("#cardElem")) {
            this.shadowRoot.querySelector("#cardElem")._selected = {};
            this.shadowRoot.querySelector("#cardElem").filters = this.filters;
        }
      }

      _userChanged(user, userToken) {
        this.set("error", false);

        if (this.user != "undefined" && this.userToken != "undefined") {
          var ajaxElem = this.$.getProjects;
          if (this.userToken && this.userToken != "undefined") {
            ajaxElem.headers = {"Authorization": "Bearer " + this.userToken};
          }
          ajaxElem.generateRequest();
        }
      }

      openProject(project) {
        this.autoOpen = true;
        this.set("error", false);

        var ajaxElem = this.$.getProjects;
        if (this.userToken && this.userToken != "undefined") {
          ajaxElem.headers = {"Authorization": "Bearer " + this.userToken};
        }

        ajaxElem.generateRequest();
        
        this.set("projectId", project);

        this.$.modal.open();
        this.$.modal.refit();

        if(this.shadowRoot.querySelector("#cardElem")) {
            this.shadowRoot.querySelector("#cardElem")._selected = {};
            this.shadowRoot.querySelector("#cardElem").filters = this.filters;
        }
      }

      openCollection(collection) {
        this.autoOpen = true;

        var project = collection.split("::");

        var ajaxElem = this.$.getProjects;
        if (this.userToken && this.userToken != "undefined") {
          ajaxElem.headers = {"Authorization": "Bearer " + this.userToken};
        }
        ajaxElem.generateRequest();

        this.set("projectId", project[0]);
        this.set("collectionId", collection);

        this.$.modal.open();
        this.$.modal.refit();

        if(this.shadowRoot.querySelector("#cardElem")) {
            this.shadowRoot.querySelector("#cardElem")._selected = {};
            this.shadowRoot.querySelector("#cardElem").filters = this.filters;
        }
      }

      _close() {
        // this.selectedChart = null;
        var newCharts = this.shadowRoot.querySelector("data-filter.new-charts");
        var currCharts = this.shadowRoot.querySelector("data-filter.curr-charts");
        if (newCharts) {
          newCharts._deselectAll();
        }
        if (currCharts) {
          currCharts._deselectAll();
        }
        this.set("selectedMeasurements", []);
        this.set("selectedExistingMeasurements", []);
        this.set("searchMeasurementsRaw", []);
      }

      _submit() {
        var envElement = this._parentContainer;
        var fids;
        var fmeasurements;
        if (this.tabSelected === 1) {
          fids = this.selectedExistingMeasurements.map(x => x.id);
          fmeasurements = this.currentChartObj[fids[0]];
        } else if (this.tabSelected === 0) {
          fids = this.selectedMeasurements.map(x => x.id);
          fmeasurements = this.measurementsRaw.filter((m) => {return fids.includes(m.id)});

          fmeasurements.sort(function(a,b) {
            return fids.indexOf(b.id) - fids.indexOf(a.id);
          });
        }

        this.selection = {};
        this.selection.chartType = this.selectedChart;

        var chartElem = document.createElement(this._chartTypes[this.selection.chartType]);
        chartElem.slot = "charts";
        chartElem.range = envElement.range;
        var chartElemType = chartElem._createChart();

        chartElem.setAttribute("measurements", JSON.stringify(fmeasurements));
        envElement.appendChild(chartElem);

        this._close();
      }

      /**
       * handles form show modal action
       */
      showAdd(target, callback) {
        this.callback = callback;
        this.$.modal.positionTarget = document;
        this.$.modal.open();
      }

      /**
       * handles form close modal action
       */
      closeAddDialog() {
        this.$.modal.close();
      }
    };

    customElements.define(EpivizMeasurementBrowser.is, EpivizMeasurementBrowser);
  </script>
</dom-module>
